# UsefullScripts

В данном репозитории находятся скрипты, автоматизирующие тот или иной мой рабочий процесс

- [kesl_cert_check_12.2.0.2412.sh](#kesl_cert_check_12.2.0.2412.sh)
- [kesl_cert_config_12.2.0.2412.sh](#kesl_cert_config_12.2.0.2412.sh)
- [kesl_edit_update_source.sh](#kesl_edit_update_source.sh)
- [debian_config.sh](#debian_config.sh)
- [kali_linux_config.sh](#kali_linux_config.sh)
- [kali_linux_gui_config.sh](#kali_linux_gui_config.sh)
- [alse_change_user_passwords_auto.sh](#alse_change_user_passwords_auto.sh)
- [alse_change_user_passwords_manual.sh](#alse_change_user_passwords_manual.sh)
- [alse_create_users.sh](#alse_create_users.sh)
- [Find-WhoDeletedFile.ps1](#Find-WhoDeletedFile.ps1)
- [Get-WindowsSharesAudit.ps1](#Get-WindowsSharesAudit.ps1)

## kesl_cert_check_12.2.0.2412.sh

Данный скрипт позволяет провести проверку конфигурации программы "Kaspersky Endpoint Security for Linux" на соответствие сертифицирванному состоянию в соответствии с руководством по эксплуатации на данное средство антивирусной защиты.

### Описание работы скрипта

В ходе работы проверяются следующие параметры:

- Запущена ли служба программы "Kaspersky Endpoint Security for Linux"
- Активирована ли программа лицензионным ключем
- Загружены ли в программу антивирусные базы
- Запущена ли задача "Защита от файловых угроз"
- Значения параметров задач программы на соответствие сертифицированной конфигурации (в соответствии с приложением "Значения параметров программы в сертифицированной конфигурации" к руководству по эксплуатации)
- Отказ от участия в KSN
- Целостность программы "Kaspersky Endpoint Security for Linux", а также GUI для нее

В скрипте также присутствуют необязательные проверки, не влияющие на состояние сертифицированности, но желательные в использовании:

- Запущена ли задача "Проверка сьемных дисков"
- Как давно в последний раз обновлялись антивирусные базы? (при > 90 дней выводится предупреждение)
- Расписание задачи "Антивирусная проверка": нежелательно чтобы она выполнялась в ручном режиме, лучше задать автоматическую периодическую проверку

## kesl_cert_config_12.2.0.2412.sh

Данный скрипт позволяет произвести конфигурацию программы "Kaspersky Endpoint Security for Linux" для соответствия сертифицирванному состоянию в соответствии с руководством по эксплуатации на данное средство антивирусной защиты.

### Описание работы скрипта

В ходе работы выполняются следующие настройки:

- Запускается задача "Защита от файловых угроз"
- Устанавливаются значения параметров задач программы для соответствия сертифицированной конфигурации (в соответствии с приложением "Значения параметров программы в сертифицированной конфигурации" к руководству по эксплуатации)
- Отключается участие в KSN

В скрипте также присутствуют необязательные настройки, не влияющие на состояние сертифицированности, но желательные в использовании:

- Запуск задачи "Проверка сьемных дисков"
- Установка расписания задачи "Антивирусная проверка" на запуск раз в неделю

## kesl_edit_update_source.sh

## debian_config.sh

Данный скрипт позволяет настроить рабочее окружение в ОС Debian

### Описание работы скрипта

Запуск скрипта для настройки системы и окружения пользователя root
```bash
curl -s https://raw.githubusercontent.com/rsherstnev/UsefullScripts/refs/heads/master/Debian/debian_config.sh | sudo bash
```

Запуск скрипта для настройки окружения обычного пользователя
```bash
curl -s https://raw.githubusercontent.com/rsherstnev/UsefullScripts/refs/heads/master/Debian/debian_config.sh | bash
```

## kali_linux_config.sh

Данный скрипт позволяет произвести настройку операционной системы Kali Linux для решения CTF тасков. Его необходимо запускать до скрипта `kali_linux_gui_config.sh`

### Описание работы скрипта

Скрипт необходимо запускать от имени пользователя root, либо с использованием `sudo`

## kali_linux_gui_config.sh

Данный скрипт позволяет произвести настройку операционной системы Kali Linux. Его необходимо запускать после отработки скрипта `kali_linux_config.sh` и входа через GUI учетной записью root

### Описание работы скрипта

Скрипт необходимо запускать от имени пользователя root, либо с использованием `sudo`

## alse_change_user_passwords_auto.sh

Данный скрипт позволяет быстро изменить пароли некоторых пользователей системы на автоматически сгенерированные

### Описание работы скрипта

Скрипт необходимо запускать от имени пользователя root, либо с использованием `sudo`

Перед запуском скрипта необходимо выставить на него бит исполнения

Если в аргументы скрипту ничего не передано, то скрипт извлекает из `/etc/passwd` всех несистемных пользователей и изменяет им пароль

Иначе скрипт изменяет пароли всех учетных записей, переданных скрипту в аргументах

При генерации паролей для пользователей учитываются заданные в автоматизированной системе требования к качеству паролей

### Примеры использования скрипта

Изменить пароли всем несистемным пользователям
```bash
sudo ./alse_change_user_passwords_auto.sh
```

Изменить пароли пользователям `secadmin`, `sysadmin` и `user1` ... `user27`
```bash
sudo ./alse_change_user_passwords_auto.sh secadmin sysadmin user{1..27}
```

## alse_change_user_passwords_manual.sh

Данный скрипт позволяет быстро вручную изменить пароли некоторых пользователей системы

### Описание работы скрипта

Скрипт необходимо запускать от имени пользователя root, либо с использованием `sudo`

Перед запуском скрипта необходимо выставить на него бит исполнения

Если в аргументы скрипту ничего не передано, то скрипт извлекает из `/etc/passwd` всех несистемных пользователей и изменяет им пароль

Иначе скрипт изменяет пароли всех учетных записей, переданных скрипту в аргументах

### Примеры использования скрипта

Изменить пароли всем несистемным пользователям
```bash
sudo ./alse_change_user_passwords_manual.sh
```

Изменить пароли пользователям `secadmin`, `sysadmin` и `user1` ... `user27`
```bash
sudo ./alse_change_user_passwords_manual.sh secadmin sysadmin user{1..27}
```

## alse_create_users.sh

Данный скрипт позволяет быстро добавить в автоматизированную систему некоторое количество пользователей

### Описание работы скрипта

Скрипт необходимо запускать от имени пользователя root, либо с использованием `sudo`

Перед запуском скрипта необходимо выставить на него бит исполнения

Если в аргументы скрипту ничего не передано, то скрипт интерактивно запросит количество создаваемых пользователей и начнет создавать их со случайно сгенерированными паролями, логины созданных пользователей при этом будут иметь вид `user1`, `user2` и т.д.

Иначе скрипт будет создавать учетные записи с логинами, переданными скрипту в аргументах

При создании пользователя будет интерактивно запрошено его Ф.И.О.

При генерации паролей для пользователей учитываются заданные в автоматизированной системе требования к качеству паролей

При создании пользователя скрипт автоматически назначает ему максимальный уровень конфиденциальности, определенный в переменной `_USER_SECRET_DEFAULT`

### Примеры использования скрипта

Создать пользователей системы, количество которых будет считано интерактивно
```bash
sudo ./alse_create_users.sh
```

Создать пользователей системы с логинами `secadmin`, `sysadmin` и `user1` ... `user27`
```bash
sudo ./alse_create_users.sh secadmin sysadmin user{1..27}
```

## Find-WhoDeletedFile.ps1

Скрипт предназначен для поиска событий удалений файлов на файловом сервере Windows (при условии, что соответствующие настройки аудита заданы)

### Описание работы скрипта

Сначала выполняется поиск всех событий с кодами 4663, 4659 в журнале "Безопасность"

После чего фильтруются именно события удаления файлов по полю "Маска доступа"

И удаляются дубликаты событий путем добавления событий в структуру данных "Хеш таблица"

Дубликаты событий наблюдаются если удалять файл в расшаренной папке на самом сервере (получив доступ на него с консоли или через RDP), а не удаленно через SMB (зайдя в проводнике по UNC пути)

### Примеры использования скрипта

> [!WARNING]
> Если командлет Invoke-WebRequest при скачивании файла выдает ошибку (преимущественно на Windows Server)
> > Запрос был прерван: Не удалось создать защищенный канал SSL/TLS
> 
> Можно явно указать команде какую версию протокола использовать, например:
> ```powershell
> [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Find-WhoDeletedFile.ps1" -OutFile Find-WhoDeletedFile.ps1
> ```

#### Предварительная загрузка скрипта в файловую систему

Загрузить скрипт с GitHub в файловую систему
```powershell
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Find-WhoDeletedFile.ps1" -OutFile Find-WhoDeletedFile.ps1
```

Импортировать функцию, описанную в файле, в текущую PowerShell сессию
```powershell
. .\Find-WhoDeletedFile.ps1
```

#### Исполнение в памяти без записи на диск

Импортировать функцию, описанную в файле, в текущую PowerShell сессию
```powershell
Invoke-Expression (New-Object System.Net.WebClient).DownloadString("https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Find-WhoDeletedFile.ps1")
```

#### Использование импортированной функции

##### Возможные опции

| Опция      | Функционал                                                                                                                           |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| StartTime | Если не указать явно - будет подразумеваться "Сегодня"<br>Иначе - поиск будет производиться с указанного времени до текущего момента |
| FileName  | Паттерн для поиска<br>Например, если указать "txt", будут искаться все файлы, которые в своем пути содержат это слово                |
| GUI       | Если не указать данную опцию, вывод найденных событий будет осуществлен в консоль, иначе - в графическое окна                        |

##### Примеры

Вывести события удаления docx файлов за сегодня в консоль
```powershell
Find-WhoDeletedFile -FileName "docx"
```

Вывести события удаления docx файлов за сегодня в графическое окно
```powershell
Find-WhoDeletedFile -FileName "docx" -Gui $true
```

Вывести события удаления всех файлов в период со вчера до текущего момента в консоль
```powershell
Find-WhoDeletedFile -StartTime (Get-Date).AddDays(-1)
```

Вывести события удаления pdf файлов в период с 15 января 2024 года до текущего момента в консоль
```powershell
Find-WhoDeletedFile -FileName "pdf" -StartTime "2024-01-15"
```

Поиск событий удаления конкретного файла в период с 15 января 2024 года до текущего момента в консоль
```powershell
Find-WhoDeletedFile -FileName "SampleToSearch.pdf" -StartTime "2024-01-15"
```

## Get-WindowsSharesAudit.ps1

Скрипт предназначен для анализа настроек аудита файловых операций на файловом сервере Windows

### Описание работы скрипта

- Проверка глобальных настроек аудита файловый операций в ОС
- Проверка настроек аудита для каждой расшаренной на сервере директории

### Примеры использования скрипта

> [!WARNING]
> Если командлет Invoke-WebRequest при скачивании файла выдает ошибку (преимущественно на Windows Server)
> > Запрос был прерван: Не удалось создать защищенный канал SSL/TLS
> 
> Можно явно указать команде какую версию протокола использовать, например:
> ```powershell
> [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Get-WindowsSharesAudit.ps1" -OutFile Get-WindowsSharesAudit.ps1
> ```

#### Предварительная загрузка скрипта в файловую систему

Загрузить скрипт с GitHub в файловую систему
```powershell
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Get-WindowsSharesAudit.ps1" -OutFile Get-WindowsSharesAudit.ps1
```

Импортировать функцию, описанную в файле, в текущую PowerShell сессию
```powershell
. .\Get-WindowsSharesAudit.ps1
```

#### Исполнение в памяти без записи на диск

Импортировать функцию, описанную в файле, в текущую PowerShell сессию
```powershell
Invoke-Expression (New-Object System.Net.WebClient).DownloadString("https://raw.githubusercontent.com/rsherstnev/UsefullScripts/master/Windows/Get-WindowsSharesAudit.ps1")
```

#### Использование импортированной функции

Проверка глобальных настроек аудита файловый операций в ОС
```powershell
Get-OSAuditSettings
```

Проверка настроек аудита для каждой расшаренной на сервере директории
```powershell
Get-AllSharesAuditSettings
```

Совместное выполнение функций `Get-OSAuditSettings` и `Get-AllSharesAuditSettings`
```powershell
Get-WindowsSharesAudit
```
